## Message stream service

### Сценарии

#### Сервера

- Создать сервер
- Поиск сервера
- Присоединяться к серверу (подписаться)
- Отписаться от сервера
- Получить список серверов, в которых состоит пользователь (сервера на которые подписан и свои созданные сервера)
- Пригласить пользователя на сервер
- Опубликовать сообщение на сервере (может только владелец сервера)
- Получить сообщения (публикации) сервера

#### Чаты

- Написать сообщение другу
- Получить сообщение из чата с пользователем

Дополнительные бизнес возможности в нашем приложении (MVP2):

- Создать канал на сервере (может только создатель сервера)
- Удалить канал на сервере (может только создатель сервера)
- Присоединиться к каналу (пользователь может одновременно быть только в одном канале)
- Отключиться от канала

### API

- Создать сервер
  `POST /server`

  ```
  {
      name: string
      tags?: string[]
  }
  ```

  Owner для сервера можно взять из токена. Дополнительно можно передавать список тегов, по которым можно искать сервер,
  тогда нужно предусмотреть хранение тегов в базе.

- Поиск сервера
  `GET /server?name=?&tags=?`

- Присоединяться к серверу (подписаться)
  `POST /server/:id/subscr`

- Отписаться от сервера
  `DELETE /server/:id/subscr`

- Получить список серверов, в которых состоит пользователь (сервера на которые подписан и свои созданные сервера)
  `GET /user/:uuid/servers`

- Пригласить пользователя на сервер
  `POST /user/:uuid/invite`

- Опубликовать сообщение на сервере (может только владелец сервера)
  `POST /server/:id/msg`
  ```
    {
        content: string
        tags: string[]
    }
  ```
- Получить сообщения (публикации) сервера
  `GET /server/:id/msg`

- Написать сообщение другу
  `POST /chats/:uuid/msg/:uuid`

  ```
  {
    content: string
  }
  ```

- Получить сообщение из чата с пользователем (возможно нужен еще список активных чатов пользователя что бы было из какого выбрать)
  `GET /chats/:uuid/msg/:uuid`

### Хранение данных

Для сохранения информации по серверах, каналах и сообщениях будет использоваться реляционная база данных (PostgreSQL).
Для реализации PubSub, кэширования сообщений и real time messaging - Redis PubSub.

Схема базы данных

`servers`

```
id number PK
name varchar not null unique constraint
owner_id uuid not null
created_at timestamp without timezone
```

`subscriptions`

```
server_id FK
subscriber_id uuid
```

`channels`

```
id number PK
name varchar not null unique constraint
server_id number FK
created_at timestamp without timezone

```

`messages`

```
id number PK
content text not null
sender_id uuid not null
server_id FK
channel_id FK nullable (только если сообщение отпралено не на весь сервер, а в канал)
created_at timestamp without timezone
```

Информацию о том что пользователь зашел в канал / вышел из него можно хранить как сессионную в Redis.
Там же в рамках MVP можно хранить сообщения чата между двумя пользователями.

### Интеграция с другими сервисами

Кажется что описанного функционала достаточно только еще отправки сообщений в топик `notifications` для
приглашения пользователя в сервис.
